<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Map with Product Locations</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css' rel='stylesheet' />
    <link rel="stylesheet" href="style.css" />

</head>
<body>
    <nav class="navbar">
        <div class="logo">
            <img src="LOGOLAV.png" style="width: 40px;">
        </div>
        <ul class="menu">
            <li><a href="index.html">Գլխավոր մենյու</a></li>
            <li><a href="services.html">Պատվերներ</a></li>
        </ul>
    </nav>

    <!-- Main Menu with Map and Product Grid -->
    <div class="main-menu">
        <div id="map"></div>
        <div class="filters">
            <select id="location-filter" onchange="applyFilters()">
                <option value="">Վայրերը
                </option>
                <option value="Ավան">Ավան</option>
                <option value="Զեյթուն">Զեյթւն</option>
                <option value="Բանգլադեշ">Բանգլադեշ</option>
                <option value="3-րդ Մաս">3րդ Մաս</option>
                <option value="Կոմիտաս">Կոմիտաս</option>
                <option value="Էրեբունի">Երեբւնի</option>
                <option value="Նորագավիթ">Նորագավիտ</option>
                <option value="Շենգավիթ">Շենգավիտ</option>
            </select>
            <select id="type-filter" onchange="applyFilters()">
                <option value="">Տեսակները
                </option>
                <option value="Ինդիկա">Ինդիկա</option>
                <option value="Սատիվա">Սատիվա</option>
                <option value="Քար">Քար</option>
                <option value="Կոկաին">Կոկաին</option>
                <option value="Lxtz">Lxtz</option>
                <option value="LSD">LSD</option>
                <option value="Շոկո">Շոկո</option>
            </select>
            <input type="number" id="price-filter" placeholder="Մաքս գինը" step="0.01" min="0" oninput="applyFilters()">
            <button id="apply-filters" onclick="applyFilters()">Որոնում</button>
        </div>
        
        
        <div class="product-menu">
            <div class="product-grid" id="product-grid"></div>
        </div>
    </div>

<!-- Modal for Payment Details -->
<!-- Modal for Payment Details -->
<div id="payment-modal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2>Վճարման մանրամասներ        </h2>

        <div id="qr-code"></div>
        <p id="dash-address">DASH Հասցե: <span id="address"></span></p>
        <p id="amount">Գումարը: <span id="amount-value"></span> DASH</p>
        <div class="loading"></div>

        <!-- Added product details -->
        <div id="product-details">
            <p id="product-name"></p>
            <p id="product-price"></p>
        </div>
    </div>
</div>



    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script>
        $(document).ready(function() {
            var map; // Define map variable at a higher scope

            

            function initMap(lat = 40.177200, lng = 44.503490) {
                if (!map) { // Initialize the map only if it's not already initialized
                    mapboxgl.accessToken = 'pk.eyJ1IjoibnVibWFzdGVyNjY2IiwiYSI6ImNseXVpN2cxNDByMHUybHNnOHZpcGppMHcifQ.n8AzCR_WFx-YDwy7G6z7Hg';
                    map = new mapboxgl.Map({
                        container: 'map',
                        style: 'mapbox://styles/mapbox/dark-v11',
                        center: [lng, lat],
                        zoom: 15
                    });
    
                    map.on('load', function () {
                        var features = [];
    
                        $('.product-item').each(function() {
                            var lat = parseFloat($(this).data('lat'));
                            var lng = parseFloat($(this).data('lng'));
                            var color = $(this).data('color');
                            var quantity = $(this).data('quantity');
    
                            // Define the range for random distances in meters
                            const minDistanceMeters = 50;
                            const maxDistanceMeters = 150;
    
                            // Generate a random distance for each polygon
                            const distanceMeters = getRandomDistance(minDistanceMeters, maxDistanceMeters);
                            const radiusDegrees = distanceMeters * 0.00001;
    
                            // Calculate polygon coordinates
                            function generateCircleCoordinates(lng, lat, radius, points = 30) {
                                const coordinates = [];
                                for (let i = 0; i < points; i++) {
                                    const angle = (i / points) * 2 * Math.PI;
                                    const offsetLng = radius * Math.cos(angle);
                                    const offsetLat = radius * Math.sin(angle);
                                    coordinates.push([
                                        lng + offsetLng,
                                        lat + offsetLat
                                    ]);
                                }
                                coordinates.push(coordinates[0]); // Close the polygon
                                return coordinates;
                            }
    
                            const coordinates = generateCircleCoordinates(lng, lat, radiusDegrees);
    
                            features.push({
                                "type": "Feature",
                                "properties": {
                                    "title": $(this).data('name'),
                                    "color": color,
                                    "quantity": quantity
                                },
                                "geometry": {
                                    "type": "Polygon",
                                    "coordinates": [coordinates]
                                }
                            });
    
                            // Add a marker for each product
                            new mapboxgl.Marker({ color: color })
                                .setLngLat([lng, lat])
                                .setPopup(new mapboxgl.Popup().setHTML(`
                                    <h3>${$(this).data('name')}</h3>
                                    <p>Price: ${$(this).data('price')}</p>
                                    <p>Description: ${$(this).data('description')}</p>
                                `))
                                .addTo(map);
                        });
    
                        var geojsonData = {
                            "type": "FeatureCollection",
                            "features": features
                        };
    
                        // Add GeoJSON data as a source on the map
                        map.addSource('products', {
                            'type': 'geojson',
                            'data': geojsonData
                        });
    
                        // Add the fill layer for circular outlines
                        map.addLayer({
                            'id': 'products-outline',
                            'type': 'fill',
                            'source': 'products',
                            'layout': {},
                            'paint': {
                                'fill-color': [
                                    'case',
                                    ['has', 'color'],
                                    ['get', 'color'],
                                    '#00f' // Default color if not specified
                                ],
                                'fill-opacity': 0.3,
                                'fill-outline-color': '#000'
                            }
                        });
    
                        // Add labels for quantities
                        map.addLayer({
                            'id': 'products-labels',
                            'type': 'symbol',
                            'source': 'products',
                            'layout': {
                                'text-field': '{quantity}', // Display quantity
                                'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
                                'text-size': 12
                            },
                            'paint': {
                                'text-color': '#000000'
                            }
                        });
                    });
    
                    // Function to generate random distance within a range
                    function getRandomDistance(min, max) {
                        return Math.random() * (max - min) + min;
                    }
                } else {
                    // Update the center if map already initialized
                    map.setCenter([lng, lat]);
                    map.setZoom(15); // Optionally set zoom level
                }
            }
                // Fetch and display products on page load
                fetchAndDisplayProducts().then(() => {
    setTimeout(() => {
        // Initialize map on page load
        initMap();
    }, 2000); // Timeout delay in milliseconds (2000 ms = 2 seconds)
});
    
            // Fetch and display products on page load
    
            // Filter products
            $('#apply-filters').click(function() {
                var locationFilter = $('#location-filter').val();
                var typeFilter = $('#type-filter').val();
                var maxPrice = parseFloat($('#price-filter').val()) || Infinity;

                $('.product-item').each(function() {
                    var itemLocation = $(this).data('location');
                    var itemType = $(this).data('type');
                    var itemPrice = parseFloat($(this).data('price').replace('$', ''));
    
                    // Check if the item matches the filters
                    var matchesLocation = locationFilter === '' || itemLocation === locationFilter;
                    var matchesType = typeFilter === '' || itemType === typeFilter;
                    var matchesPrice = itemPrice <= maxPrice;
    
                    // Show or hide the item based on filter criteria
                    if (matchesLocation && matchesType && matchesPrice) {
                        $(this).show();
                    } else {
                        $(this).hide();
                    }
                });
            });
    
            async function fetchAndDisplayProducts() {
                $.ajax({
                    url: 'https://site-45i5.onrender.com/api/products', // Endpoint to fetch products
                    method: 'GET',
                    success: function(data) {
                        // Clear existing products
                        $('#product-grid').empty();
    
                        // Populate product items
                        data.products.forEach(function(product) {
                            const productItem = $('<div>', { class: 'product-item' })
                                .attr('data-name', product.name)
                                .attr('data-price', `$${product.price.toFixed(2)}`)
                                .attr('data-lat', product.latitude)
                                .attr('data-lng', product.longitude)
                                .attr('data-type', product.type)
                                .attr('data-description', product.description) // Added
                                .attr('data-image', product.product_image) // Added
                                .attr('data-location', product.location) // Added
                                .html(`
                                    <div class="product-price">$${product.price.toFixed(2)} ${product.weight}g </div>
                                    <img src="${product.product_image}" alt="${product.name} Image">
                                    <div class="product-specific">
                                        <div class="product-name">${product.name}</div>
                                        <div class="product-location">${product.location}</div>
                                        <div class="product-type">${product.type}</div>
                                    </div>
                                    <button class="buy-button">Գնել</button>
                                `);
    
                            $('#product-grid').append(productItem);
                        });
    
                        // Reinitialize map with fetched products
                        initMap();
                    },
                    error: function() {
                        alert('Failed to fetch products.');
                    }
                });
            }
    
            // Update map center when a product is clicked
            $(document).on('click', '.product-item', function() {
                var lat = parseFloat($(this).data('lat'));
                var lng = parseFloat($(this).data('lng'));
                initMap(lat, lng); // Update map center
            });
    
            $(document).on('click', '.buy-button', function() {
                var price = $(this).siblings('.product-price').text().replace('$', '');
                var dashAddress = 'XdAUmwtig27HBG6WfYyHAzP8n6XC9jESEw';
                var conversionRate = 0.05; // Example conversion rate from USD to DASH
                var amountInDASH = parseFloat(price) * conversionRate;
    
                // Get product details
                var productImage = $(this).siblings('img').attr('src');
                var productName = $(this).siblings('.product-specific').find('.product-name').text();
                var productPrice = $(this).siblings('.product-price').text();
    
                // Update modal with product details
                $('#address').text(dashAddress);
                $('#amount-value').text(amountInDASH.toFixed(2));
                $('#product-name').text(productName);
                $('#product-price').text(productPrice);
    
                // Show loading animation
                $('#loading-animation').show();
                $('#qr-code').hide();
    
                // Generate QR Code for DASH address
                var qrCodeUrl = 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + encodeURIComponent(dashAddress);
                $('#qr-code').attr('src', qrCodeUrl).show();
    
                // Show payment modal
                $('#payment-modal').fadeIn();
            });
    
            $('.close-btn').click(function() {
                $('#payment-modal').fadeOut();
            });
    
            $('#payment-modal').click(function(event) {
                if ($(event.target).is('#payment-modal')) {
                    $('#payment-modal').fadeOut();
                }
            });
        });
    </script>
    
        </script>
</body>
</html>
